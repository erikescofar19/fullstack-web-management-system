<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" type="image/png" href="logo.png">
<title>Men√∫ Interactivo - El Saz√≥n de Tet√©</title>
<link rel="stylesheet" href="styles.css">
<style>
html, body {
  height: 100%; margin: 0; font-family: Inter, Arial, sans-serif;
  background-image: url('assets/bg.jpg'); background-size: cover;
  background-position: center; background-repeat: no-repeat;
  background-attachment: fixed; color: #222; display: flex;
  justify-content: center; align-items: flex-start; padding: 20px;
  box-sizing: border-box; min-height: 100vh;
}
.container { display: flex; flex-direction: column; align-items: center; gap: 16px; background: rgba(255,255,255,0.9); backdrop-filter: blur(8px); border-radius: 16px; padding: 24px; box-shadow: 0 8px 24px rgba(0,0,0,0.15); max-width: 1100px; width: 100%; }
.titulo-logo { display: flex; align-items: center; justify-content: center; gap: 12px; flex-wrap: wrap; background: rgba(255,255,255,0.85); padding: 12px 16px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); font-weight: bold; font-size: 1.2rem; }
.logo { width: 15%; max-width: 180px; height: auto; }
.link-reservar { display: block; text-align: center; font-size: 1rem; color: #2c3e50; text-decoration: none; font-weight: 600; transition: color 0.2s; }
.link-reservar:hover { color: #d35400; text-decoration: underline; }
.menu-wrap { display: flex; gap: 16px; flex-wrap: wrap; width: 100%; }
.menu-column { flex: 1 1 420px; }
.order-panel { flex: 0 0 320px; }
.card, .menu-card, .order-panel, .menu-column.card { background: #fff; border-radius: 10px; }
.menu-card { cursor: pointer; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #ccc; }
.menu-card.selected { border-color: #0b8457; background-color: #e6f3eb; }
.order-item { display: flex; justify-content: space-between; align-items: center; margin: 6px 0; }
.order-item .controls { display: flex; align-items: center; gap: 6px; }
.btn { padding: 6px 12px; border-radius: 6px; cursor: pointer; }
.btn-sm { font-size: 0.85rem; padding: 4px 8px; }
#orderTotal { margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.7); backdrop-filter: blur(6px); border-radius: 8px; text-align: right; font-weight: bold; font-size: 1rem; }
.input-field { margin: 6px 0; padding: 6px 8px; width: 100%; border-radius: 6px; border: 1px solid #ccc; font-size: 0.95rem; box-sizing: border-box; }
.small { font-size:0.9rem; color:#333; }
@media (max-width: 720px) { .menu-wrap { flex-direction: column; } .order-panel { width: 100%; } .container { padding: 16px; } .logo { width: 30%; max-width: 200px; } }
</style>
</head>
<body>
<div class="container">
  <h1 class="titulo-logo">
    <img src="assets/logo.png" alt="El Saz√≥n de Tet√© ‚Äî logo" class="logo" />
  </h1>
  <a href="reservar.html" class="link-reservar">üìÖ Hacer una reserva</a>

  <div id="menuWrap" class="menu-wrap">
    <div id="menuItemsContainer" class="menu-column card">
      <h3 style="text-align:center;margin-top:0;">Men√∫</h3>
      <div id="menuItems" class="menu-grid">Cargando men√∫...</div>
    </div>

    <div id="menuOrderSection" class="order-panel card">
      <h3 style="margin-top:0;">Tu pedido</h3>
      <div id="orderSummary">
        <div style="font-size:0.95rem;color:#666">Haz clic en un platillo para agregarlo al pedido. Ajusta cantidad a la derecha.</div>
        <div class="order-list" id="orderList"></div>
        <div id="orderTotal">Total: $0</div>
        <input type="text" id="numeroMesa" class="input-field" placeholder="N√∫mero de mesa">
        <textarea id="notasPedido" class="input-field" placeholder="Notas / alergias / modificaciones" rows="3"></textarea>
        <button id="btnSubmitOrder" class="btn">Hacer pedido</button>
        <p id="orderMsg" class="small"></p>
      </div>
    </div>
  </div>
</div>

<script type="module">
import { db } from './app.js';
import { collection, doc, serverTimestamp, onSnapshot, runTransaction, setDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const menuItemsEl = document.getElementById('menuItems');
const orderListEl = document.getElementById('orderList');
const btnSubmitOrder = document.getElementById('btnSubmitOrder');
const orderMsg = document.getElementById('orderMsg');
const orderTotalEl = document.getElementById('orderTotal');
const numeroMesaEl = document.getElementById('numeroMesa');
const notasPedidoEl = document.getElementById('notasPedido');

const orderMap = new Map();

function escapeHtml(str) {
  if (!str) return '';
  return String(str).replaceAll('&','&amp;').replaceAll('<','&lt;').replaceAll('>','&gt;').replaceAll('"','&quot;').replaceAll("'",'&#39;');
}

function renderMenu(docs) {
  menuItemsEl.innerHTML = '';
  docs.forEach(docItem => {
    const it = docItem.data();
    const name = it.nombre ?? 'Sin nombre';
    const precio = parseFloat(it.precio) || 0;
    const card = document.createElement('div');
    card.className = 'menu-card';
    card.dataset.name = name;
    card.dataset.precio = precio;
    card.innerHTML = `<div><div class="name">${escapeHtml(name)}</div><div class="desc">${escapeHtml(it.descripcion||'')}</div></div><div><div class="price">${precio?('$'+precio.toFixed(2)):''}</div></div>`;
    if(orderMap.has(name)) card.classList.add('selected');
    card.addEventListener('click', ()=> {
      if(orderMap.has(name)){
        const cur = orderMap.get(name); cur.cantidad++; orderMap.set(name,cur);
      } else {
        orderMap.set(name,{nombre:name,cantidad:1,precio});
        card.classList.add('selected');
      }
      renderOrderList();
    });
    menuItemsEl.appendChild(card);
  });
}

onSnapshot(collection(db,"menus"), snapshot => {
  if(!snapshot.docs.length){
    menuItemsEl.innerHTML = '<p style="padding:12px">No hay platillos en el men√∫.</p>';
    return;
  }
  renderMenu(snapshot.docs);
}, err => {
  console.error("Error al escuchar menus:", err);
  menuItemsEl.innerHTML = '<p style="padding:12px">Error cargando men√∫.</p>';
});

function renderOrderList(){
  orderListEl.innerHTML = '';
  if(!orderMap.size){
    orderListEl.innerHTML = '<p style="color:#666">A√∫n no agregas platillos.</p>';
    document.querySelectorAll('.menu-card.selected').forEach(c=>c.classList.remove('selected'));
    updateTotal();
    return;
  }
  document.querySelectorAll('.menu-card').forEach(c=>{
    const nm = c.dataset.name;
    if(orderMap.has(nm)) c.classList.add('selected'); else c.classList.remove('selected');
  });

  orderMap.forEach((item,key)=>{
    const row = document.createElement('div');
    row.className = 'order-item';
    row.innerHTML = `<div class="left"><strong>${escapeHtml(item.nombre)}</strong></div>
                     <div class="controls">
                       <input type="number" min="1" class="qty" value="${item.cantidad}" title="Cantidad">
                       <button class="removeBtn btn-sm" title="Quitar" style="background:#e74c3c;color:#fff;border:none;">Quitar</button>
                     </div>`;
    row.querySelector('.qty').addEventListener('change', e=>{
      let v = parseInt(e.target.value,10);
      if(isNaN(v)||v<1)v=1;
      e.target.value=v;
      orderMap.set(key,{...item,cantidad:v});
      updateTotal();
    });
    row.querySelector('.removeBtn').addEventListener('click',()=>{
      orderMap.delete(key);
      renderOrderList();
    });
    orderListEl.appendChild(row);
  });
  updateTotal();
}

function updateTotal(){
  let total=0;
  orderMap.forEach(i=>{ total += (i.precio||0)*i.cantidad; });
  orderTotalEl.innerText='Total: $'+total.toFixed(2);
}

function shortId(len=6){ return Math.random().toString(36).slice(2,2+len); }

async function createOrderTransaction(){
  if(!navigator.onLine){ orderMsg.innerText='No hay conexi√≥n.'; return; }
  if(!orderMap.size){ orderMsg.innerText='Selecciona al menos un platillo.'; return; }

  orderMsg.innerText='Generando orden...';
  const platillos = Array.from(orderMap.values()).map(i=>({nombre:i.nombre,cantidad:i.cantidad}));
  const mesa = numeroMesaEl?.value || null;
  const notas = notasPedidoEl?.value || null;

  const hoy = new Date();
  const yyyy = hoy.getFullYear(), mm = String(hoy.getMonth()+1).padStart(2,'0'), dd = String(hoy.getDate()).padStart(2,'0');
  const contadorRef = doc(db,'contadorPedidos',`contador-${yyyy}-${mm}-${dd}`);

  try{
    let nextNumber;
    await runTransaction(db, async t => {
      const snap = await t.get(contadorRef);
      const last = snap.exists()? (snap.data().lastNumber||0) : 0;
      nextNumber = last + 1;
      t.set(contadorRef,{lastNumber: nextNumber});
    });

    const pedidoId = `pedido-${yyyy}${mm}${dd}-${nextNumber}-${shortId(4)}`;
    const pedidoRef = doc(db,'pedidos',pedidoId);
    await setDoc(pedidoRef,{
      orderNumber: nextNumber,
      platillos,
      status:'pendiente',
      createdAt: serverTimestamp(),
      numeroMesa: mesa||null,
      notas: notas||null
    });

    orderMsg.innerText=`‚úÖ Pedido creado. N√∫mero de pedido: ${nextNumber}`;
    orderMap.clear();
    renderOrderList();
    if(numeroMesaEl) numeroMesaEl.value='';
    if(notasPedidoEl) notasPedidoEl.value='';
    console.log('Pedido creado:', pedidoId, 'numero=', nextNumber);

  } catch(err){
    console.error('Error al crear pedido:', err);
    orderMsg.innerText='Error al crear el pedido. Revisa la consola.';
  }
}

btnSubmitOrder.addEventListener('click', createOrderTransaction);
renderOrderList();
</script>
</body>
</html>
